# 功能逻辑审查报告

## 结论
本次按“功能正确性与稳定性”审查了 `app/src/main/java` 下主要业务代码与相关资源。发现 6 个值得优先处理的问题，其中 2 个为高/中高风险（涉及数据一致性和潜在数据丢失）。

## Findings（按严重级别）

### 1. [高] 删除交易流程不是原子操作，存在数据丢失窗口
- 位置：`app/src/main/java/ASIA/TPD/vibecheck/data/FileRepository.kt:65`
- 位置：`app/src/main/java/ASIA/TPD/vibecheck/data/FileRepository.kt:66`
- 现象：当前先 `file.delete()`，再 `tmp.renameTo(file)`。若 `renameTo` 失败（跨卷、I/O 异常、系统中断等），原文件已删，临时文件又未替换成功，会导致账本丢失。
- 风险：删除单条记录时可能演变为“全部数据不可恢复”。

### 2. [中高] 文件读写无串行化控制，快速操作下可能出现状态竞争
- 位置：`app/src/main/java/ASIA/TPD/vibecheck/data/TransactionViewModel.kt:34`
- 位置：`app/src/main/java/ASIA/TPD/vibecheck/data/TransactionViewModel.kt:41`
- 位置：`app/src/main/java/ASIA/TPD/vibecheck/data/TransactionViewModel.kt:48`
- 位置：`app/src/main/java/ASIA/TPD/vibecheck/data/FileRepository.kt:49`
- 现象：`add/delete/clear` 都在独立 IO 协程中直接操作同一文本文件，未加互斥或单线程队列。高频点击时可能交错执行，出现“UI 列表回退”“最新操作被旧读取覆盖”等异常。
- 风险：账单状态非预期，极端情况下会引发文件内容竞争。

### 3. [中] 金额键盘退格键文本异常（乱码），影响可用性
- 位置：`app/src/main/java/top/lucanex/top/vibecheck/ui/screens/AddEntryScreen.kt:110`
- 位置：`app/src/main/java/top/lucanex/top/vibecheck/ui/screens/AddEntryScreen.kt:272`
- 现象：键盘最后一键与匹配分支使用了 `"鈱?`（疑似编码损坏），用户界面无法直观识别“退格”。
- 风险：用户误操作率上升，输入体验明显下降。

### 4. [中] 可滚动 `Column` 内使用 `weight`，布局行为不稳定
- 位置：`app/src/main/java/top/lucanex/top/vibecheck/ui/screens/SettingsScreen.kt:82`
- 位置：`app/src/main/java/top/lucanex/top/vibecheck/ui/screens/SettingsScreen.kt:181`
- 位置：`app/src/main/java/top/lucanex/top/vibecheck/ui/screens/SettingsScreen.kt:248`
- 现象：`verticalScroll` 容器内放置 `Spacer(weight=1f)` 通常不符合预期，会导致留白异常或在不同屏幕表现不一致。
- 风险：设置页在小屏/大屏上的排版稳定性差，易出现“空白过大/内容挤压”。

### 5. [低] 新手引导文案强制走系统语言，与应用语言设置不一致
- 位置：`app/src/main/java/top/lucanex/top/vibecheck/ui/screens/OnboardingScreen.kt:55`
- 位置：`app/src/main/java/top/lucanex/top/vibecheck/ui/screens/OnboardingScreen.kt:173`
- 现象：`getSystemString()` 强制使用 `Resources.getSystem().configuration` 的 locale，而不是应用当前 locale。
- 风险：用户已在应用内切换语言时，新手引导仍显示系统语言，体验割裂。

### 6. [低] 隐私文本回退策略默认中文，非中英文场景可能跳到中文
- 位置：`app/src/main/java/top/lucanex/top/vibecheck/ui/screens/PrivacyScreen.kt:76`
- 现象：未命中语言文件时优先回退 `privacy_zh-CN.txt`。
- 风险：例如未来新增西语/法语但未补隐私文本时，用户可能看到中文而非英文兜底。

## 测试缺口
- 未看到针对 `FileRepository` 的单元测试（尤其是删除/异常/并发场景）。
- 未看到金额输入逻辑（`updateAmount`）的边界测试。
- 未看到设置页布局在不同尺寸设备下的 UI 测试。

## 建议修复优先级
1. 先修复 `FileRepository` 删除原子性与事务安全（问题 1）。
2. 增加文件操作串行化（问题 2），再补并发回归测试。
3. 修复金额键盘退格字符（问题 3）。
4. 清理设置页 `verticalScroll + weight` 组合（问题 4）。
5. 统一语言回退策略（问题 5、6）。
